# Kimball维度建模技术概述

## 2.1 基本概念

- 收集业务需求和数据实现

  - 理解业务需求，理解作为基础的源数据的实际情况

  - 与业务代表交流来发现需求

  - 数据实际情况可以通过与源系统专家交流， 构建高层次数据分析访问数据可行性来揭示

    > 英文版原文：
    >
    > data realities are uncovered by meeting with source system experts and doing high-level data profiling to assess data feasibilities.
    >
    > 理解：
    >
    > - 与业务系统研发交流，理解表结构
    > - 探查业务数据，获得profiling，也就是业务数据知识，比如字段的值域，最大值，最小值

- 协作：维度建模研讨

  - 数据建模师负责具体工作，但维度模型需要由主题专家（数仓人员）和来自业务的数据管理代表共同设计完成
  - 协作上需要开展一系列高级别的交互讨论（非技术细节，毕竟要跟业务代表沟通）
  - 对于业务方的好处：提供了一次丰富业务需求 的机会
  - 协作是模型设计成功的关键，维度模型不应该由不懂业务和业务需求的人来设计

- 维度设计过程（4步骤）

  - 设计期间设计4个主要的决策：
    - （1）选择业务过程
    - （2）声明粒度
    - （3）确认维度
    - （4）确认事实
  - 需要考虑：业务需求、底层数据源
  - 业务数据管理代表也必须参与详细的设计活动，以确保涵盖正确的业务

- 业务过程（Business Processes）

  - 业务过程是组织完成的操作型活动

  - 业务过程事件建立或获取性能度量，并转换为事实表中的事实

    > 事实表中的事实，来自于业务过程的事件，业务行为事件会产生相关的性能指标数据（也就是度量值）

  - 业务过程的选择非常重要，因为业务过程定义了特定的设计目标以及对粒度、维度、事实的定义

    > 这里的选择分两个层面：
    >
    > - 业务过程粒度的选择，也是是否对业务事件做抽象。
    >   - 比如”安全处置“，处置的动作可以是封禁、不推荐。那么”处置“实际上就是一系列处置动作的抽象。而封禁也可以作为业务过程，只不过是更细粒度的业务过程。
    > - 覆盖的业务环节的选择。比如评级会涉及到送审、人工打标、打标结果聚合，那么业务过程可以有：
    >   - 评级结果：覆盖评级结果的聚合环节
    >   - 评级送审：覆盖数据送审、人工打标两个环节
    >
    > 业务过程一旦选择好了，就意味着设计目标也基本确定，粒度和维度、事实的定义也相应的有了定义的轮廓

  - 每个业务过程对应企业数据仓库总线矩阵的一行

- 粒度（Grain）

  - 声明粒度是维度设计的重要步骤，也是设计过程必须遵守的协议（contract）

  - 在选择维度或事实前必须声明粒度，因为每个**候选维度或事实**必须与定义的粒度保持一致

    > 比如账户粒度下，账户信息等维度可以和账户余额等事实存一个表中
    >
    > 但在客户粒度下，账户信息就不能存在了

    > 维度与维度之间，是存在粒度信息的，设计上要注意

  - 在所有维度设计中**强制实行一致性是保证BI应用性能和易用性的关键**

  - 实践上建议：

    - 从原子级别粒度数据开始设计
    - 上卷粒度对于数仓的性能调整非常重要，但需要猜测业务公共问题
    - 针对不同粒度的事实表，需要建立不同的物理表，同一事实表不能混用不同粒度

- 描述环境的维度

  - 维度提供围绕某一业务过程事件所涉及的 “ 谁、什么、何处、何时、为什么、如何” 等背景

  - 维度表包含B1应用所需要的用于**过滤及分类**事实的描述性属性

  - 牢牢掌握事实表 的粒度，就能够将所有可能存在的维度区分开

    > 怎么理解？

  - 当与给定事实表行关联时，任何情况下都应使维度保持单一值

    > 怎么理解？

  - 维度表有时被称为数仓的”灵魂“，因为维度能够被用作业务分析的入口和描述性标识

- 用于度量的事实

  - 事实涉及来自业务过程事件的度量，基本上都是数量值

  - 事实表对应一个物理可观察的事件：一个事实表行与按照事实表粒度描述的度量事件之间存在一对一关系

    > 再加深理解

  - 在事实表内，所有事实只允许与声明的粒度保持一致

- 星型模式与OLAP 多维数据库

  - 星型模式是部署在**关系型数据库**之上的多维结构（事实表+通过主/外键关联的维度表）
  - OLAP多维数据库是实现在**多维数据库**之上的多维结构，与关系型星型模式内容等价，或者说来源于关系型星星模式
  - OLAP多维数据库能够使用具有比SQL语言具有更强分析能力的语言访问

- （数据变化可以）方便地扩展到维度模型

  - 维度模型对数据关系发生变化具有灵活的适应性

    -  当事实与存在的事实表粒度一致时，可以创建新列。

    - 通过建立新的外键列，可以将维度关联到己经存在的事实表上，前提是维度列与事实表粒度保持一致。

    - 可以在维度表上通过建 立新列添加属性。

    - 可以使事实表的粒度更原子化，方法是在维度表上增加属性，然后以更细的粒度重置事实表，注意保护事实表及维度表的列名。

      > 通过在维度表新建一个字段X，然后新建一个粒度更低的事实表，并将新加的字段X作为新事实表的外键？

## 2.2 事实表技术基础

- 事实表结构

  - 发生在现实世界中的操作性事件，及其产生的可度量数值，存储在事实表中
  - 从最低 的粒度级别米看，事实表行对应一 个度量事件，反之亦然
  - 事实表的设计完全依赖 于物理活动， 不受可能产生的最终报表的影响
  - 除数字度量外，事实表总是包含外键，用 于关联与之相关的维度，也包含可选的退化维度健和日期/ 时间戰
  - 查询请求的主要目标是基于事实表开展计算和聚集操作

- 可加、半可加、不可加事实

  事实表中的数字度量可划分为三类：

  - 完全可加：最灵活、最有用，可以在任意维度上汇总
  - 半可加：只能对某些维度汇总。比如差额是常见的半可加事实，除了时间维度外，其他维度都可进行加法操作
  - 完全不可加：比如比率。处理上，拆出完全可加的分量，比如拆成分子分母两个字段分别存储

- 事实表中的空值
  - 可以存在空值度量。所有聚合函数均可针对控制计算
  - 事实表中的外键不能存在空值，否则会导致违反参照完整性的情况发生。关联的维表必须用默认行（代理键）而不是空值外键来表示未知的或无法应用的条件
- 一致性事实
  - 不同事实表中的度量，如果需要比较或计算不同事实表中 的事实，应保证针对事实的技术定义是相同的
    - 如果不同的事实表定义是一致的，则这些一致性事实应该具有相同的命名
    - 如果它们不兼容，则应该有不同的命名用于告诚业务用户和BI 应用



几种事实表

| 类型              | 定义说明                                                                                                                                                                                                          | 备注                                                                           |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
| 事务事实表           | - 事务事实表的一行对应空问或时间上某点的度量事件<br />- 原子事务粒度事实表是最维度化及最可表达的事实表，这类健壮的维度确保对事务数据的最大化分片和分块（待加深理解）<br />- 事务事实表可 以是稠密的，也可以是稀疏的，因为仅当存在度量时才会建立行<br />- 度量数字事实必须与事务粒度保持一致                                                   | 这应该是DWD表最常见的事实表                                                              |
| 周期快照事实表         | - 周期快照事实表中的每行汇总了发生在某一标准周期，如某一天、某周、某月的多个度量事件<br />- 粒度时周期性的，而不是单个的事务，可以包括许多事实（粒度一致的度量时间都被允许存在）<br />- 这些事实表的密度是均匀的，即便周期内没有事实发生，表中也会为每个事实行写入0或者空值                                                               |                                                                              |
| 累积快照事实表         | - 累积快照事实表的行汇总 了发生在过程开始和结束之间可预测步骤内的度量事件<br />- 通常在事实表中针对过程中的关键步骤都包含日期外键<br />- 数据行为上：产生订单会插入一行，进行中某个节点，该行的数据被访问并修改<br />- 通用也会包含一些滞后性的数值度量指标，这些度量与粒度保持一致，同时符合里程碑完成计数（along with milestone completion counters） | 管道或工作流过程(例如，履行订单或索赔过程)具有定义的开始点，标淮中间过程，定义的结束点，它们在此类事 实表中都可以被建模<br />也叫多事务事实表？ |
| 无事实的事实表         | - 存在某些事件仅仅记录一系列某一时刻发生的多维实体，没有对应的可度量数值产生<br />- 利用无事实的事实表也可以分析发生了什么：实际发生的活动事实表，所有可能事件的无事实覆盖表，从覆盖表中刨除活动事件，剩下的就是尚未发生的事件                                                                                          | 比如记录某天中发生的学生参加课程的事件，可能没有课记录的数字化事实                                            |
| 聚集事实表活OLAP多维数据库 | - 聚集事实表是对原子粒度事实表数据进行简单的数字化上卷操作，目的是为了提高查 询性能<br />- 适 当设计的聚集集合应该类似数据库索引， 能够提高查询性能，但不需要直接面对BI 应用或商业用户<br />- 聚集事实表包含外键以缩小一致性维度，聚集事实的构建是通过对来自多个原子事实表的度量的汇总而获得的                                                   |                                                                              |
| 合并事实表           | -  通常将米自多个业务过程的，以相同粒度表示的事实合并为一个单一的合并事实表<br />- 合并 事 实表会增加ETL处理过程的负担，但降低了BI 应用的分析代价。<br />- 合并事实表特别适合 那些经常需要共同分析的多过程度量。                                                                                        | 例如，现货销售可以与销售预测合并为一张事实表，与针对多个不同的事实表采用下钻应用比较                                   |



## 2.3 维度表技术基础

- 维度表结构
  - 每个维度表都包含单一的主键列，维度表的主键可以作为与之关联的任何事实表的外键
  
  - 维度表通常比较宽，是扁平型非 规范表，包含大量的低粒度的文本属性
  
  - 操作代码和指示器(indicators)可以被作为维度的2个属性，信息量巨大的属性通常被冗长的描述填充
  
    > 操作代码和指示器可以理解为维度值，指示器是对操作代码的解释
  
  - 维度表属性是查询及BI 应用的**约束和分组定义**的主要目标
  
  - 报表的描述性标识通常是维度表属性领域值

- 下钻

  - 下钻是商业用户分析数据的最基本的方法
  - 




几种键的概念

> 维度表中会包含一个列，表示唯一主键，该主键不能是操作型系统的自然键（因为需要跟踪变化，使用自建键的话会需要多个维度行来表示；如果由多个源系统建立，还会出现兼容性问题，难以管理）


| 概念    | 定义说明                                                                                                                    | 备注                         |
|-------|-------------------------------------------------------------------------------------------------------------------------|----------------------------|
| 维度代理键 | - DW/BI 系统需要声明对所有维度的主键的控制<br />- 对于无法采用单一的自然键或附加日期的自然键，可为每个维度建立无语义的整型主键<br />- 日期维度不需要遵守代理键规则，这是高度可预测且稳定的味道，可以使用更有意义的主键 | 代理键可按顺序分配的简单整数，比如从1开始，不断加1 |
| 自然键   | 由源系统建立，受业务规则影响，无法被DW/BI系统控制                                                                                             | 比如员工辞职后再次入职，员工ID（自然键）可能会变化 |
| 持久键   | - 同一个对象有用一个持久唯一的ID<br />- 好的持久键其格式应该独立于原始的业务过程，可以以整数1开始分配                                                               | 比如员工不管入职多少次，都只有一个单一键       |
| 超自然键  | 将来源表各子集的自然键加工成一个字段                                                                                                      |                            |

几种维度的概念

| 概念               | 定义说明                                                   | 备注                                                         |
| ------------------ | ---------------------------------------------------------- | ------------------------------------------------------------ |
| 退化               | 维度除了主键外没有其他内容                                 | 退化维度常见于交易和累计快照事实表                           |
| 非规范化扁平维度   | 将非规范化的多对一固定深度层次引入扁平维度行的不同属性     |                                                              |
| 多层次维度         | 多数维度包含不止一个自然层次                               | 时间：天-周-月，位置密集型维度：区-市-省-国家                |
| 维度表中的空值属性 | 推荐采用描达性字符串替代空值                               | 应该避免在维度属性中使用空值，因为不同的数据库系统在处理分组和约束时，针对空值的处理方法不一致 |
| 日历日期维度       |                                                            |                                                              |
| 扮演角色的维度     |                                                            |                                                              |
| 杂项维度           |                                                            |                                                              |
| 雪花维度           | 扁平化的、非规范化的维度表完全能够获得与雪花模式相同的信息 |                                                              |
| 支架维度           |                                                            |                                                              |

## 2.4 使用一致性维度集成

