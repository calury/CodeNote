## 流式数据架构理论

为了让数据处理程序具有强一致性和实时性，将强实时性的storm和强一致性的hadoop融合在一起，也就是Lambda架构。但是这样的架构需要维护两套队列集群，数据也需要持久化存放两份

- flink架构

![image](https://github.com/fancyChuan/bigdata-learn/blob/master/flink/img/flink架构.png?raw=true)


解决数据包乱序的三种窗口机制：
- 设定固定时间间隔的session窗口
    - 一般通过数据分析等方式计算两个session之间的合理的时间间隔，比如1小时
    - 这种窗口机制很简单，但仍需要比如1小时才能得到结果
- 设定session的事件推进标志
    - 使用水印和推进事件时间，用于表明某个时间点之前的数据包均已发送完毕
    - 这种方式可以实时得到结果，也就是说，水印是流式数据处理系统中事件流转的同步信号
    - 这种方式需要深刻理解应用领域知识，生成水印的代价也比较高
- 触发器实时生成近似结果
    - 系统先在正常的session结束时间点计算出结果，如果后面观察到迟到的数据包，那么撤回原来的结果重新计算得到新的结果
    
    
流式机器学习应用
- 线下训练模型、线上实时抽取特征
- 实时机器学习

![image](https://github.com/fancyChuan/bigdata-learn/blob/master/flink/img/阿里巴巴实时机器学习模型架构.png?raw=true)


### 3.流式数据架构基本概念
#### 3.1 流
最开始是通过微批方式处理的，比如Spark Streaming，这种方式牺牲了延迟和吞吐行

可以定义流是一种为无界数据集设计的数据处理引擎，具有以下特征：
- 具备强一致性，即支持exactly-once语义
- 提供丰富的实践工具，比如事件时间、处理时间、窗口
- 保证系统具有可弹性、伸缩性
- 同时保证高吞吐、低延迟和容错
- 支持高层语义，如流式关系型API（SQL）、复杂事件处理（CEP，Complex Event Processing）

#### 3.2 时间
事件/记录： 从需要的数据集中那去的数据，在Flink中，通常以有结构的对象表示

事件时间event time

处理时间processing time

CAP原理：一个分布式系统最多具备一致性、可用性以及分区容错性中的两个特性，不可能同时具备三个特性
- 一致性：分布式系统中同一数据的所有备份，在同一时刻，其值是相同的，或者说所有客户端读取的值是相同的
- 可用性：集群的部分节点出现故障后，集群还能正常响应客户端的读写请求
- 分区容错性：即便发生了分区，分布式系统仍能正常响应客户端的读写请求
> 分区是对分布式系统通信时限的要求，即如果不能在有限时间内达成数据一致，则系统发生分区

#### 3.3 窗口
将（有界/无界）数据集拆分成一个个有限长度数据区间的机制，即在数据集中增加临时处理边界，用于将事件按时间或其他特征分组分析。通常有三类窗口：
- 滚动窗口（Tumbling Window）: 将时间拆分成固定长度

![image](https://github.com/fancyChuan/bigdata-learn/blob/master/flink/img/滚动窗口.png?raw=true)

- 滑动窗口（Sliding Window）：按照滑动步长将时间拆分成固定长度

![image](https://github.com/fancyChuan/bigdata-learn/blob/master/flink/img/滑动窗口.png?raw=true)

- 会话窗口（Session Window）：以活动时间间隔为边界，将一系列连续事件拆分到不懂的会话中。会话窗口的长度是动态的

![image](https://github.com/fancyChuan/bigdata-learn/blob/master/flink/img/会话窗口.png?raw=true)

#### 3.4 水印
水印是嵌入在事件时间轴上用于判断事件时间窗口内所有数据均已到达引擎的一种时间推理工具，是一种既可以在流处理引擎侧嵌入，又可以在消息系统侧嵌入的时间戳

水印也是事件的推进器

水印有两类：
- 完美水印：表示遭遇水印标识事件时间戳的所有记录均已到达，非乱序的无界数据集中最近一条记录的事件时间就是完美水印。设计很困难
- 启发式水印：尽可能地确定时间戳的一种估计，可能出现某些事件晚于水印到达的情况。代价相对较低

时空穿梭：出于调试或者审计的目的，处理程序需要将事件时间倒回到过去某个时间点

#### 3.5 触发器
决定在窗口的什么时间点启动应用程序定义的数据处理任务
 
水印迟到会拉长窗口生存期、早到会导致数据处理结果不准确。触发器能有效解决这两个问题

#### 3.6 数据处理模式
- 有界数据处理：比如MR中的WordCount程序，特征是将有界数据集处理成规整的形式并输出
- 无界数据批处理：使用窗口机制把数据分隔成一系列有界数据块，多个微批任务串接起来构成流式数据处理任务，通常牺牲了延迟和吞吐
- 无界数据流式处理
    - 无界数据特点：
        - 无序：引擎需要有时间处理机制
        - 事件时间偏差：引擎不能假定在某个时间窗口内能够观察到所有事件
    - 四种无界数据的流式处理模式
        - 时间无关： 过滤、连接
        - 近似计算：也与时间无关，优点是系统开销小。
        - 根据处理时间开滚动窗口：优点是使用简单、窗口边界容易确定、易于提供与事件时间无关的语义
        - 根据事件时间开滚动窗口：更灵活，但对引擎的挑战也更大，比如需要大容量的缓存以持久化状态、窗口边界难以确定

#### 3.7 如何理流式数据框架的内在机制
- what
- where
- when
- how
